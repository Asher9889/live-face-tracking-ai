from insightface.app import FaceAnalysis
import numpy as np

class InsightFaceEngine:

    MIN_FACE_SIZE = 30
    MIN_SCORE = 0.5

    def __init__(self, det_size=(640, 640)):
        self.app = FaceAnalysis(
            name="buffalo_l",
            providers=["CUDAExecutionProvider"]
        )

        self.app.prepare(ctx_id=0, det_size=det_size) # ctx_id=0 means use first GPU 
        print("[AI] InsightFace Engine Ready (GPU Enabled)")

    def detect_and_generate_embedding(self, frame: np.ndarray, offset=(0, 0)):
        """
        frame  : ROI or full frame
        offset : (x_offset, y_offset) if frame is cropped ROI
        """

        faces = self.app.get(frame)
        """
        Resize for Detection 640 * 640
        Detect Face
        Landmark Detection
        Alignment
        Recognition Resize 112 * 112 * 3. this size arcface expects.
        """

        if not faces:
            return []

        results = []

        x_offset, y_offset = offset

        for face in faces:
            score = float(face.det_score)
            if score < self.MIN_SCORE:
                continue

            bbox = face.bbox.astype(np.int32)
            width = bbox[2] - bbox[0]
            height = bbox[3] - bbox[1]

            if min(width, height) < self.MIN_FACE_SIZE:
                continue

            # Convert to global coordinates (important if ROI used)
            global_bbox = np.array([
                bbox[0] + x_offset,
                bbox[1] + y_offset,
                bbox[2] + x_offset,
                bbox[3] + y_offset
            ])

            yaw, pitch, roll = face.pose if face.pose is not None else (0, 0, 0)

            results.append({
                "bbox": global_bbox,
                "score": score,
                "landmarks": face.kps.astype(np.int32),
                "embedding": face.embedding,   # 512-d vector
                "pose": (yaw, pitch, roll),
                "age": int(face.age) if hasattr(face, "age") else None,
                "gender": int(face.gender) if hasattr(face, "gender") else None
            })

        return results




# faces are [{'bbox': array([ 75,  21, 175, 158], dtype=int32), 'score': 0.656549334526062, 'landmarks': array([[ 98,  54],
#        [127,  61],
#        [ 89,  79],
#        [ 88, 114],
#        [108, 119]], dtype=int32), 'embedding': array([ 0.08780748, -1.144184  ,  2.057697  ,  1.3621104 ,  0.9456152 ,
#        -0.27120158, -0.18195853,  0.06212318,  1.3801179 ,  1.420288  ,
#        -0.19196242,  1.4490943 , -1.4108082 , -0.82029295,  1.0479345 ,
#         0.17566937, -0.56597185, -0.14744401,  1.0092466 ,  1.0777252 ,
#         0.5880001 ,  0.5530725 ,  0.6307878 ,  0.4537853 ,  0.3569652 ,
#        -0.47012216,  0.40316075,  0.57174337,  0.11204599, -0.6631302 ,
#        -0.24992083, -1.545315  ,  0.1745209 , -0.39020917,  1.3345973 ,
#        -2.3651395 , -1.2746172 , -1.9559996 ,  1.3435704 ,  0.43607464,
#        -1.1335431 , -1.171335  ,  0.3169725 ,  1.203461  , -0.47134784,
#         0.178729  ,  0.11115681,  1.0142372 , -1.1171834 ,  0.30112708,
#        -0.5817217 ,  0.3878734 ,  1.3351421 ,  1.1532272 , -0.7942487 ,
#        -0.73672014,  1.6383939 , -0.35730883,  1.322749  , -1.0362732 ,
#        -0.55282193,  0.27029923, -0.09027557,  0.60743415,  1.2856178 ,
#        -0.99230397, -0.16532868, -0.5432348 ,  0.49298513, -0.01420107,
#        -0.6406767 , -0.4205228 ,  0.28645885, -0.50521415,  0.02472737,
#         1.4513979 ,  0.25097215, -0.02694949,  0.63295805,  1.1138467 ,
#        -0.0388041 ,  0.6496145 ,  0.9867857 ,  1.2033892 ,  0.07854597,
#         0.028763  ,  0.78271747,  0.36866653,  1.4576862 ,  1.0042154 ,
#        -1.0939783 , -0.3702394 , -0.5914756 ,  0.2316524 , -0.02209704,
#         0.97926646, -0.40342027, -1.2717824 , -2.3014212 ,  0.3673781 ,
#         0.7074832 , -0.8733369 ,  0.8366723 , -0.47153988,  0.64638424,
#        -1.0591011 , -0.18972877, -1.2428648 ,  1.4020452 ,  0.22008163,
#        -1.161302  , -0.6223282 ,  0.9704064 , -0.96167946,  1.8753757 ,
#         0.66842055,  0.9267669 ,  1.180966  , -1.0496621 , -0.13733834,
#         0.9523195 , -0.17516036,  0.83537745, -0.56413704,  0.55732137,
#         0.4542232 ,  1.0396646 , -1.38491   ,  0.02596852, -1.6913579 ,
#        -0.84302086, -0.4011443 , -0.6172615 ,  0.40625742, -1.0067931 ,
#        -1.0697601 ,  1.3103466 ,  0.05351639, -1.113525  ,  0.25232622,
#         1.2608045 , -0.16133255,  0.15776685,  1.0312196 ,  0.6472082 ,
#         0.59947264, -1.7434552 ,  1.756117  ,  0.92788875, -0.41852945,
#         0.4556467 ,  0.32155246,  0.05328595, -1.0206604 , -0.02315663,
#        -0.4287657 ,  0.75411904, -0.34920835, -0.8108932 ,  0.0603221 ,
#         0.52678835, -0.2566188 , -1.2292013 ,  0.2844513 , -0.23616931,
#         0.27676567,  0.64510477,  0.3581161 , -0.18941134, -0.8915622 ,
#         0.9037874 ,  1.1451508 , -0.04050778,  0.01170342,  1.3835135 ,
#         0.29647574, -0.93301356,  0.20665583, -0.56451035, -0.23829973,
#         0.99429536, -0.5789461 , -0.6194824 ,  0.5843201 , -1.5451975 ,
#        -0.39859307, -1.1193471 ,  0.8741409 , -0.44281027,  0.59439534,
#         0.7134688 ,  1.291912  , -0.87127525,  0.08245075, -1.2879521 ,
#        -0.28527611, -0.10051565, -0.19009568,  0.82420784, -0.20530087,
#         1.7617139 , -0.282471  , -1.0210702 ,  2.947692  ,  0.18683532,
#         0.49363363,  1.5524361 , -0.60534996,  0.3418567 , -0.7871266 ,
#         1.419805  , -0.6270715 ,  0.08941981,  1.6510267 , -0.83707535,
#        -0.32982382, -1.6266346 , -0.9083559 , -0.50724596, -0.5510638 ,
#        -0.8811146 , -0.89046156,  0.7011484 ,  0.03560625,  1.9167771 ,
#        -0.08157421, -0.3565971 ,  0.6217916 ,  0.86863667, -0.920663  ,
#         0.08360656, -0.7504027 ,  2.5801508 ,  0.29512203, -0.51582557,
#        -0.28766984,  0.71433485,  0.38768017, -0.74761385,  1.0072739 ,
#         0.6771999 ,  0.08055905,  2.104321  ,  0.59042317,  0.16506736,
#         0.46695772,  0.7244457 , -0.13554184,  1.6807519 , -0.18891051,
#         0.30134484,  1.3007435 ,  0.3562725 ,  0.27726862,  0.08097796,
#        -1.1904795 , -0.5897717 ,  0.38918036, -1.4511223 , -1.6603637 ,
#         1.1321455 ,  1.0599284 , -0.00876134, -1.7275034 ,  1.6621715 ,
#         0.36589646, -0.66795135,  0.346417  ,  0.6568341 ,  1.2546598 ,
#         0.32860157, -0.36634105, -0.6396423 , -0.99016815,  0.3260205 ,
#        -0.22207403,  0.4330415 , -1.2462313 ,  0.45055777,  1.1622429 ,
#        -1.1349472 , -0.84708446, -0.14268629, -0.96427876, -0.45096856,
#         0.76381433,  1.3684766 ,  0.59860456, -0.27285326, -1.5064766 ,
#        -0.18576059,  0.22267476, -0.04498909, -1.1480045 , -0.57406366,
#        -1.154957  , -0.82942677, -1.6051011 ,  0.79126173, -0.15324229,
#         2.0213614 , -1.4559679 ,  0.9108651 ,  1.8680282 , -0.14408699,
#        -0.19607572, -0.8651741 ,  1.0725774 ,  0.3792762 ,  0.13296145,
#        -0.23504245, -0.77361286,  0.73487234,  0.89344466,  0.709676  ,
#        -0.50386995,  1.7483385 , -0.7961844 ,  0.44479382,  0.6735356 ,
#         0.43576962, -0.8114276 , -0.5476696 ,  0.3265809 , -1.9905286 ,
#        -1.4937227 ,  0.08378482,  1.6135727 , -1.2202505 ,  0.93220764,
#        -1.8625023 ,  0.23325688,  1.6099548 ,  0.9042116 , -0.7661047 ,
#        -0.26808527,  0.5760447 ,  1.4342906 ,  1.2520292 , -0.36661622,
#         1.3401582 ,  1.4511211 ,  1.0222864 , -0.33489698, -0.17542383,
#         0.8469242 , -0.16623726, -0.36297467, -0.6184872 , -0.15465984,
#         0.30585513,  0.35976395,  1.1025898 ,  0.07395194,  0.2671967 ,
#        -0.65524685, -0.623868  ,  0.7909393 , -0.5102897 ,  0.38184398,
#         0.5660962 ,  0.12369523, -0.33454856,  1.2513583 ,  0.12751031,
#         1.3923874 ,  0.81310517, -0.43822563, -0.26683336,  0.12331384,
#         0.14215125,  1.6001362 , -1.6094289 , -0.01809338, -0.6356548 ,
#        -0.8847048 ,  0.8429638 ,  0.81484073,  0.56883454, -1.3241382 ,
#        -0.44823027, -1.2492527 , -3.0305235 , -1.7204281 , -0.3849983 ,
#        -2.656677  , -0.4483369 , -0.31483892, -0.6075683 , -0.23318748,
#        -0.02830304, -0.53433955,  0.60181427,  0.04744288,  1.5178074 ,
#        -0.66866696, -0.59954494, -0.8623922 , -0.24975705,  0.6549561 ,
#         0.41760182,  0.03380846, -0.33775198, -1.07466   , -0.84824675,
#        -0.22674817, -0.44176322,  0.5611085 ,  1.2399325 , -0.2876822 ,
#        -0.7129363 ,  0.4126136 ,  0.22980255,  1.0843841 , -0.09531952,
#        -1.3045874 ,  0.16617455, -1.0478184 , -0.09991236,  0.7848814 ,
#         1.459458  , -0.59705454,  0.10629985, -0.3896899 , -0.5026847 ,
#         0.49785727, -0.37527397,  0.46410066, -0.17434947, -0.27657175,
#         1.4678086 ,  0.6302213 ,  1.5417458 ,  2.9348035 ,  0.573488  ,
#         1.2162889 ,  0.9422855 , -0.03326052,  0.13833494, -0.20155163,
#        -0.6852721 , -0.09593061, -0.06820788, -0.57644284, -1.2781224 ,
#         0.43637496, -0.9848707 , -0.62941253,  0.84050447, -0.5091593 ,
#         0.23307584, -1.4974554 , -0.7511342 , -0.6436213 ,  0.25817692,
#        -0.8745957 , -0.32930532, -1.4867737 , -1.4245238 , -0.03758237,
#        -0.27118862,  0.48053753,  0.47631422, -1.5896062 , -0.4091138 ,
#        -1.3668969 , -1.3099974 , -1.297207  , -1.2411817 ,  0.7608969 ,
#        -1.0616977 , -0.21685356,  0.8652736 ,  1.2970266 ,  1.3164251 ,
#        -0.88938975,  1.461964  , -0.6358986 , -0.32196373, -1.3436137 ,
#        -0.6413622 , -1.186599  , -0.4855455 , -1.022135  ,  0.0435982 ,
#         0.02190844,  0.1616139 ,  1.5320069 ,  0.27371675,  0.7989884 ,
#        -0.00886749, -0.96042395, -0.28904867,  0.8806639 , -0.85484856,
#         0.33141205,  0.6698502 ,  1.4729251 , -0.5774952 ,  1.2343156 ,
#         1.6727878 , -0.4294173 ,  0.7437606 ,  0.09290384,  0.7359084 ,
#         0.68038064, -2.7119875 , -0.76752573, -1.7140254 , -0.8425219 ,
#        -2.6310368 ,  0.97759145], dtype=float32), 'pose': (np.float32(-10.717302), np.float32(-58.0689), np.float32(14.815533)), 'age': 38, 'gender': 1}]